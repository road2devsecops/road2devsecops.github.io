# Basic Bash Scripting Menggunakan AWK

## Apa itu AWK

AWK atau GAWK (GNU awk) merupakan tools text processing yang sangat powerfull. Selain untuk text processing gawk juga dapat dimanfaatkan untuk mempermudah kita untuk melakukan automasi, config dan lain sebagainya.

## Bekerja menggunakan AWK

Sebelum memulai menggunakan awk, adabaiknya kita membaca dokumentasinya terlebih dahulu. Untuk melihat dokumentasi atau man page dari awk menggunakan perintah sebagai berikut :
```
man awk
```

## Contoh penggunaan awk

Ada 2 file yang digunakan untuk contoh
a.txt
```
ID  Nama    Gender  Age     Hobby
1   Udin    Male    22      Mancing
2   Samsul  Male    13      Berenang
3   Vina    Female  23      Memasak
4   Sri     Female  15      Olahraga
```

b.csv
```
ID,Nama,Gender,Age,Hobby
1,Udin,Male,22,Mancing
2,Samsul,Male,13,Berenang
3,Vina,Female,23,Memasak
4,Sri,Female,15,Olahraga
```
### Versi awk  

`Command :`
```
awk --version
```
`Output :`
```
GNU Awk 4.1.4, API: 1.1 (GNU MPFR 4.0.1, GNU MP 6.1.2)
Copyright (C) 1989, 1991-2016 Free Software Foundation.

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see http://www.gnu.org/licenses/.
```
### Ekstraksi kolom  
Perintah berikut digunakan untuk melakukan ekstraksi kolom pertama dari file dengan delimiter default (whitespace/spasi/tab) `a.txt`  
`Command :`
```
awk '{print $1}' a.txt
```
`Output :`
```
ID
1
2
3
4
```
**Penjelasan** :  
|`awk`|`'{print $1}'`|`a.txt`|
|-|-|-|
|awk command|print kolom pertama|nama file|

Berikut contoh ekstrasi kolom menggunakan delimiter koma pada file `b.csv`  
`Command :`
```
awk -F ',' '{print $2}' b.csv
```
`Output :`
```
Nama
Udin
Samsul
Vina
Sri
```
**Penjelasan** :  
|`awk`|`-F`|`','`|`'{print $2}'`|`a.txt`|
|-|-|-|-|-|
|awk command|menentukan delimiter|delimiter|print kolom kedua|nama file|

### Ekstrak & Construct

Seelah belajar cara melakukan ekstraksi kolom, kita juga dapat memodifikasi output yang kita inginkan, sebagai contoh :  
`Command :`
```
awk -F ',' '{print "Hallo "$2" hobby saya "$5}' b.csv
```
`Output :`
```
Hallo Nama hobby saya Hobby
Hallo Udin hobby saya Mancing
Hallo Samsul hobby saya Berenang
Hallo Vina hobby saya Memasak
Hallo Sri hobby saya Olahraga
```
**Penjelasan** :  
|`'{print`|`"Hallo "`|`$2`|`" hobby saya "`|`$5}'`|
|-|-|-|-|-|
|print|string tambahan|kolom ke-2|string tambahan|kolom ke-5|

### Mencari string
`Command :`
```
awk '/Samsul/' a.txt
```
`Output :`
```
2   Samsul  Male    13      Berenang
```
**Penjelasan**  
|`awk`|`'/Samsul/'`|`a.txt`|
|-|-|-|
|awk|String yang dicari|Nama file|

### Automasi Konfigurasi Hostame dari file csv
Task kali ini kita ditugaskan untuk setting hostname di beberapa server yang akan digunakan untuk deployment aplikasi, kita diberikan satu file `server.csv` yang berisi informasi server. Untuk format hostnamenya adalah sebagai berikut :  
```
Region-Type-Host
ex : JKT-HPE-DL380-worker
```

File csv :  
```
IP,Type,Host,Region
192.168.30.12,HPE-DL380,controller,JKT
192.168.30.14,HPE-DL380,worker,JKT
192.168.30.15,HPE-DL380,worker,BGR
192.168.30.16,HPE-DL380,worker,BGD
```

Pertama kita coba generate hostname dan IP terlebih dahulu.  
`Command :`
```
awk -F ',' '{print $1" "$4"-"$2"-"$3}' server.csv
```
`Output :`
```
IP Region-Type-Host
192.168.30.12 JKT-HPE-DL380-controller
192.168.30.14 JKT-HPE-DL380-worker
192.168.30.15 BGR-HPE-DL380-worker
192.168.30.16 BGD-HPE-DL380-worker
```

Untuk konfigurasi `/etc/hosts` kita harus menghilangkan header `IP Region-Type-Host`. Kita bisa memanfaatkan fitur search string untuk mengeliminasi string tersebut.

`Command :`
```
awk -F ',' '/192/{print $1" "$4"-"$2"-"$3}' server.csv
```
`Output :`
```
192.168.30.12 JKT-HPE-DL380-controller
192.168.30.14 JKT-HPE-DL380-worker
192.168.30.15 BGR-HPE-DL380-worker
192.168.30.16 BGD-HPE-DL380-worker
```

Sekarang untuk menandakan konfigurasi ini digereate oleh awk kita dapat memanfaatkan statmen `BEGIN`.  
`Command :`
```
awk -F ',' 'BEGIN{print "#Generated by awk"}/192/{print $1" "$4"-"$2"-"$3}' server.csv
```
`Output :`
```
#Generated by awk
192.168.30.12 JKT-HPE-DL380-controller
192.168.30.14 JKT-HPE-DL380-worker
192.168.30.15 BGR-HPE-DL380-worker
192.168.30.16 BGD-HPE-DL380-worker
```

Sekarang kita aplikasikan konfigurasi tersebut ke file `/etc/hosts` ke server.
Buat file hostname.sh
```
vim hostname.sh
```
Masukan script berikut untuk generate dan apply config ke server.
```
#!/bin/bash
## Generate config
FILE=server.csv
awk -F ',' 'BEGIN{print "#Generated by awk"}/192/{print $1" "$4"-"$2"-"$3}' $FILE > config

## Apply config using ssh
for i in $(awk -F ',' '/192/{print $1}' $FILE);
  do 
    echo "Configuring $i";
    echo "cat config | ssh root@$i 'cat >> /etc/hosts'";
done
```

Ubah permission untuk eksekusi
```
chmod 760 hostname.sh
```

Eksekusi script
```
./hostname.sh
```
`Output :`
```
Configuring 192.168.30.12
Configuring 192.168.30.14
Configuring 192.168.30.15
Configuring 192.168.30.16
```

### Optimasi script
1. Ubah variable `$FILE` menjadi argument agar eksekusi script menjadi `./hostname.sh nama-file.csv`